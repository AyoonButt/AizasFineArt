{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Artworks - Artist Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-neutral-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-neutral-200">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-h1 font-playfair font-bold text-neutral-800">Manage Artworks</h1>
                    <p class="text-neutral-600 mt-1">Organize and edit your artwork collection</p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'artwork_create' %}" class="btn-primary">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Add New Artwork
                    </a>
                    <a href="{% url 'dashboard' %}" class="btn-outline">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-soft p-6 mb-8">
            <h2 class="text-lg font-playfair font-semibold text-neutral-800 mb-4">Filter & Search</h2>
            
            <form method="get" class="grid md:grid-cols-4 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-2">Search</label>
                    <input type="search" 
                           name="search" 
                           value="{{ current_filters.search }}"
                           placeholder="Search by title..."
                           class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-2">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Medium -->
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-2">Medium</label>
                    <select name="medium" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">All Media</option>
                        {% for value, label in medium_choices %}
                            <option value="{{ value }}" {% if current_filters.medium == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Featured -->
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-2">Featured</label>
                    <select name="featured" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">All Artworks</option>
                        <option value="true" {% if current_filters.featured == 'true' %}selected{% endif %}>Featured Only</option>
                        <option value="false" {% if current_filters.featured == 'false' %}selected{% endif %}>Not Featured</option>
                    </select>
                </div>

                <div class="md:col-span-4 flex items-center space-x-4">
                    <button type="submit" class="btn-primary">Apply Filters</button>
                    <a href="{% url 'artwork_list' %}" class="btn-outline">Clear All</a>
                </div>
            </form>
        </div>

        <!-- Bulk Actions -->
        <div class="bg-white rounded-xl shadow-soft p-4 mb-6" id="bulk-actions" style="display: none;">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-neutral-600">
                        <span id="selected-count">0</span> artworks selected
                    </span>
                    <button onclick="selectAll()" class="text-sm text-primary-600 hover:text-primary-700">Select All</button>
                    <button onclick="clearSelection()" class="text-sm text-neutral-600 hover:text-neutral-700">Clear Selection</button>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="bulkAction('feature')" class="btn-sm bg-accent-100 text-accent-700 hover:bg-accent-200">Feature</button>
                    <button onclick="bulkAction('unfeature')" class="btn-sm bg-neutral-100 text-neutral-700 hover:bg-neutral-200">Unfeature</button>
                    <button onclick="bulkAction('activate')" class="btn-sm bg-green-100 text-green-700 hover:bg-green-200">Activate</button>
                    <button onclick="bulkAction('deactivate')" class="btn-sm bg-red-100 text-red-700 hover:bg-red-200">Deactivate</button>
                    <button onclick="bulkAction('delete')" class="btn-sm bg-red-500 text-white hover:bg-red-600">Delete</button>
                </div>
            </div>
        </div>

        <!-- Artworks List -->
        <div class="bg-white rounded-xl shadow-soft overflow-hidden">
            {% if artworks %}
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-neutral-50 border-b border-neutral-200">
                            <tr>
                                <th class="px-6 py-3 text-left">
                                    <input type="checkbox" id="select-all" onchange="toggleSelectAll()" class="rounded border-neutral-300 text-primary-600 focus:ring-primary-500">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Artwork</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Details</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Pricing</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-neutral-200">
                            {% for artwork in artworks %}
                            <tr class="hover:bg-neutral-50">
                                <td class="px-6 py-4">
                                    <input type="checkbox" class="artwork-checkbox rounded border-neutral-300 text-primary-600 focus:ring-primary-500" 
                                           value="{{ artwork.id }}" onchange="updateBulkActions()">
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 w-16 h-16">
                                            {% if artwork.main_image_url %}
                                                <img {% if forloop.counter <= 10 %}src="{{ artwork.thumbnail_url }}"{% else %}src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1' height='1'%3E%3C/svg%3E" data-src="{{ artwork.thumbnail_url }}"{% endif %}
                                                     alt="{{ artwork.title }}" 
                                                     class="artwork-image {% if forloop.counter > 10 %}lozad lazy-load{% endif %} w-16 h-16 rounded-lg object-cover"
                                                     data-lazy="true"
                                                     data-aspect-ratio="1/1"
                                                     data-priority="{% if forloop.counter <= 10 %}high{% else %}normal{% endif %}"
                                                     loading="{% if forloop.counter <= 10 %}eager{% else %}lazy{% endif %}">
                                            {% else %}
                                                <div class="w-16 h-16 bg-neutral-100 rounded-lg flex items-center justify-center">
                                                    <svg class="w-6 h-6 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                    </svg>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-neutral-900">{{ artwork.title }}</div>
                                            <div class="text-sm text-neutral-500">Created {{ artwork.created_at|date:"M d, Y" }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-neutral-900">{{ artwork.get_medium_display }}</div>
                                    <div class="text-sm text-neutral-500">{{ artwork.dimensions_display }}</div>
                                    {% if artwork.year_created %}
                                        <div class="text-sm text-neutral-500">{{ artwork.year_created }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4">
                                    {% if artwork.original_price %}
                                        <div class="text-sm font-medium text-neutral-900">${{ artwork.original_price }}</div>
                                    {% else %}
                                        <div class="text-sm text-neutral-500">No price set</div>
                                    {% endif %}
                                    {% if artwork.prints_available %}
                                        <div class="text-xs text-green-600">Prints available</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex flex-col space-y-1">
                                        {% if artwork.original_available %}
                                        <span class="bg-mocha text-white text-xs px-2 py-1 rounded-full w-fit font-medium">Original</span>
                                        {% endif %}
                                        {% if artwork.is_featured %}
                                            <span class="bg-accent-100 text-accent-700 text-xs px-2 py-1 rounded-full w-fit">Featured</span>
                                        {% endif %}
                                        {% if not artwork.is_active %}
                                            <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full w-fit">Inactive</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center space-x-2">
                                        <a href="{{ artwork.get_absolute_url }}" 
                                           target="_blank"
                                           class="p-2 text-neutral-400 hover:text-primary-600 transition-colors" 
                                           title="View Public Page">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                        </a>
                                        <a href="{% url 'artwork_update' artwork.pk %}" 
                                           class="p-2 text-neutral-400 hover:text-primary-600 transition-colors" 
                                           title="Edit">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </a>
                                        <button onclick="toggleFeatured({{ artwork.pk }}, this)" 
                                                class="p-2 text-neutral-400 hover:text-accent-600 transition-colors" 
                                                title="Toggle Featured">
                                            <svg class="w-4 h-4" fill="{% if artwork.is_featured %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                            </svg>
                                        </button>
                                        <a href="{% url 'artwork_delete' artwork.pk %}" 
                                           class="p-2 text-neutral-400 hover:text-red-600 transition-colors" 
                                           title="Delete"
                                           onclick="return confirm('Are you sure you want to delete {{ artwork.title }}?')">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                <div class="px-6 py-4 border-t border-neutral-200">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-neutral-700">
                            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} artworks
                        </div>
                        <div class="flex items-center space-x-2">
                            {% if page_obj.has_previous %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" 
                                   class="px-3 py-2 border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">Previous</a>
                            {% endif %}

                            {% for page_num in page_obj.paginator.page_range %}
                                {% if page_num == page_obj.number %}
                                    <span class="px-3 py-2 bg-primary-500 text-white rounded-lg">{{ page_num }}</span>
                                {% else %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_num }}" 
                                       class="px-3 py-2 border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">{{ page_num }}</a>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
                                   class="px-3 py-2 border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">Next</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="text-center py-12">
                    <svg class="w-12 h-12 text-neutral-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <h3 class="text-lg font-medium text-neutral-900 mb-2">No artworks found</h3>
                    <p class="text-neutral-600 mb-6">
                        {% if current_filters.search or current_filters.status or current_filters.medium or current_filters.featured %}
                            Try adjusting your filters or search terms.
                        {% else %}
                            Start building your collection by adding your first artwork.
                        {% endif %}
                    </p>
                    <div class="flex justify-center space-x-4">
                        {% if current_filters.search or current_filters.status or current_filters.medium or current_filters.featured %}
                            <a href="{% url 'artwork_list' %}" class="btn-outline">Clear Filters</a>
                        {% endif %}
                        <a href="{% url 'artwork_create' %}" class="btn-primary">Add New Artwork</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Bulk actions functionality
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.artwork-checkbox:checked');
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    
    selectedCount.textContent = checkboxes.length;
    bulkActions.style.display = checkboxes.length > 0 ? 'block' : 'none';
}

function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.artwork-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBulkActions();
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.artwork-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('select-all').checked = true;
    updateBulkActions();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.artwork-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('select-all').checked = false;
    updateBulkActions();
}

function bulkAction(action) {
    const checkboxes = document.querySelectorAll('.artwork-checkbox:checked');
    const artworkIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (artworkIds.length === 0) {
        alert('Please select at least one artwork');
        return;
    }
    
    if (action === 'delete' && !confirm(`Are you sure you want to delete ${artworkIds.length} artwork(s)? This action cannot be undone.`)) {
        return;
    }
    
    fetch('{% url "bulk_artwork_action" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: action,
            artwork_ids: artworkIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            window.location.reload();
        } else {
            showNotification(data.error || 'Action failed', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Action failed', 'error');
    });
}

// Toggle featured status for artwork
function toggleFeatured(artworkId, button) {
    fetch(`/dashboard/artwork/${artworkId}/toggle-featured/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const star = button.querySelector('svg');
            if (data.is_featured) {
                star.setAttribute('fill', 'currentColor');
                button.classList.add('text-accent-600');
                button.classList.remove('text-neutral-400');
            } else {
                star.setAttribute('fill', 'none');
                button.classList.remove('text-accent-600');
                button.classList.add('text-neutral-400');
            }
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Failed to update artwork', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to update artwork', 'error');
    });
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Initialize checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const artworkCheckboxes = document.querySelectorAll('.artwork-checkbox');
    artworkCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
});
</script>
{% endblock %}