{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Watercolor & Oil Paintings by Aiza{% endblock %}

{% block meta_description %}{% if breadcrumb_medium %}Explore Aiza's {{ breadcrumb_medium|lower }} collection.{% else %}Browse Aiza's complete gallery of watercolor and oil paintings.{% endif %} Original artworks and fine art prints from Fort Worth, Texas.{% endblock %}

{% block content %}
<!-- Gallery Hero Section with Breadcrumbs -->
<section class="hero-section relative section-padding bg-gradient-hero overflow-hidden">
    <div class="container">
        
        <div class="text-center max-w-4xl mx-auto">
            <div>
                <h1 class="text-page-title text-white mb-6">
                    {{ page_title }}
                </h1>
                <p class="text-body text-white mb-8 max-w-2xl mx-auto leading-relaxed">
                    {% if breadcrumb_medium %}
                        Discover my {{ breadcrumb_medium|lower }} paintings, where {{ breadcrumb_medium|lower|slice:":1" }}{% if breadcrumb_medium == "Watercolors" %}ach piece captures the flowing beauty of water-based pigments{% elif breadcrumb_medium == "Oil Paintings" %}ach work explores rich textures and vibrant colors{% else %}ach creation combines multiple artistic techniques{% endif %}.
                    {% else %}
                        Discover the complete collection of my watercolor and oil paintings. Each piece captures 
                        a unique moment through the interplay of light, color, and emotion.
                    {% endif %}
                </p>
            </div>
            
            
            <!-- Gallery Filter Component -->
            <div class="gallery-filter-component bg-surface/80 backdrop-blur-sm rounded-2xl p-6 shadow-soft">
                <!-- Medium Filter Pills -->
                <div class="flex flex-wrap gap-3 justify-center mb-6">
                    <button class="medium-filter-pill active" data-medium="all">
                        All Mediums
                    </button>
                    <button class="medium-filter-pill" data-medium="watercolor">
                        Watercolors
                    </button>
                    <button class="medium-filter-pill" data-medium="oil">
                        Oil Paintings
                    </button>
                    <button class="medium-filter-pill" data-medium="mixed-media">
                        Mixed Media
                    </button>
                </div>
                
                <!-- Search Bar -->
                <div class="flex items-center justify-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-caption font-medium text-primary">Search:</label>
                        <input type="search" 
                               id="gallery-search-input" 
                               placeholder="Search artworks..." 
                               class="form-input min-w-48">
                    </div>
                    
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="featured-filter" 
                               class="rounded border-muted text-primary focus:ring-primary">
                        <span class="text-caption font-medium text-primary">Featured Only</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Gallery Results Header -->
<section class="py-8 bg-surface border-b border-muted section-border-top from-hero-section watercolor-natural">
    <div class="container">
        <div class="flex justify-between items-center">
            <div class="text-secondary">
                Showing {{ artworks|length }} of {{ paginator.count }} artworks
                {% if current_filters.search %} for "{{ current_filters.search }}"{% endif %}
            </div>
            <div class="flex items-center gap-4">
                <!-- View Toggle -->
                <div class="flex items-center bg-muted rounded-lg p-1">
                    <button class="view-toggle active px-3 py-2 rounded text-caption font-medium" data-view="large" title="Large Cards">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                    </button>
                    <button class="view-toggle px-3 py-2 rounded text-caption font-medium" data-view="small" title="Small Cards">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Gallery Grid -->
<section class="section-padding bg-surface">
    <div class="container">
        <!-- Gallery Grid using Masonry Layout -->
        <div id="gallery-container" class="gallery-grid-large">
            {% for artwork in artworks %}
            <div class="artwork-item group relative overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-300"
                 data-medium="{{ artwork.medium }}"
                 data-title="{{ artwork.title }}"
                 data-created="{{ artwork.created_at|date:'c' }}"
                 onclick="window.location.href='{{ artwork.get_absolute_url }}'">
                
                <!-- Image Container with Loading State -->
                <div class="artwork-image-container relative overflow-hidden">
                    {% if artwork.main_image_url %}
                        <img src="{{ artwork.image_url }}" 
                             alt="{{ artwork.alt_text|default:artwork.title }}"
                             class="artwork-image w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                             loading="{% if forloop.counter <= 8 %}eager{% else %}lazy{% endif %}"
                             decoding="async"
                             data-aspect-ratio="4/5">
                    {% else %}
                        <!-- Placeholder Image -->
                        <div class="w-full h-full bg-muted flex items-center justify-center">
                            <div class="text-center">
                                <svg class="w-16 h-16 text-muted mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span class="text-caption text-muted">{{ artwork.title }}</span>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Title Overlay on Hover -->
                    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <div class="absolute bottom-0 left-0 right-0 p-4">
                            <h3 class="text-artwork-title mb-1 text-white text-outline">{{ artwork.title }}</h3>
                            <p class="text-caption text-white text-outline">{{ artwork.get_medium_display }}</p>
                            {% if artwork.is_featured %}
                            <span class="inline-block mt-2 bg-primary text-white text-caption px-2 py-1 rounded-full font-medium shadow-lg">
                                Featured
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Wishlist Button -->
                    <button class="absolute top-3 right-3 w-8 h-8 bg-black/80 hover:bg-black backdrop-blur-md rounded-full flex items-center justify-center shadow-xl border border-white/20 transition-all duration-300 opacity-0 group-hover:opacity-100"
                            onclick="event.stopPropagation(); toggleWishlist('{{ artwork.id }}');"
                            title="Add to Wishlist">
                        <svg class="w-4 h-4 text-white hover:text-red-400 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-12">
                <div class="text-6xl mb-4">ðŸŽ¨</div>
                <h3 class="text-artwork-title text-primary font-semibold mb-2">No artworks found</h3>
                <p class="text-body text-secondary mb-6">
                    {% if current_filters.search %}
                        No artworks match your search "{{ current_filters.search }}". Try different keywords or 
                    {% endif %}
                    Try adjusting your filters or browse all artworks.
                </p>
                <div class="flex gap-4 justify-center">
                    {% if current_filters.search or current_filters.status or current_filters.featured %}
                    <button onclick="clearFilters()" class="btn btn-primary">Clear Filters</button>
                    {% endif %}
                    <a href="{% url 'gallery' %}" class="btn btn-secondary">Browse All Artworks</a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Load More / Pagination -->
        {% if page_obj.has_next %}
        <div class="text-center mt-12">
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
               class="btn btn-primary">
                Load More Artworks
            </a>
        </div>
        {% endif %}

        <!-- Traditional Pagination (fallback) -->
        {% if paginator.num_pages > 1 %}
        <nav class="pagination mt-12 flex justify-center">
            <div class="flex items-center space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" 
                       class="px-3 py-2 border border-muted rounded-lg hover:bg-muted transition-colors">Previous</a>
                {% endif %}

                {% for page_num in paginator.page_range %}
                    {% if page_num == page_obj.number %}
                        <span class="px-3 py-2 bg-primary text-white rounded-lg">{{ page_num }}</span>
                    {% else %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_num }}" 
                           class="px-3 py-2 border border-muted rounded-lg hover:bg-muted transition-colors">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
                       class="px-3 py-2 border border-muted rounded-lg hover:bg-muted transition-colors">Next</a>
                {% endif %}
            </div>
        </nav>
        {% endif %}
    </div>
</section>

<!-- Call to Action -->
<section class="section-padding bg-mist-blue section-border-top from-surface-section watercolor-natural">
    <div class="container text-center">
        <div class="max-w-3xl mx-auto">
            <h2 class="text-section-heading text-primary mb-6">
                {% if breadcrumb_medium %}
                    Love {{ breadcrumb_medium }}? 
                {% else %}
                    Found Something You Love?
                {% endif %}
            </h2>
            <p class="text-body text-vintage-rosewood mb-8">
                {% if breadcrumb_medium %}
                    Explore other mediums or commission a custom {{ breadcrumb_medium|lower }} piece just for you.
                {% else %}
                    Each artwork tells a unique story. Commission a custom piece or browse by medium to find your perfect match.
                {% endif %}
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{% url 'contact' %}" class="btn bg-mauve-plum text-white hover:bg-mauve-plum-600">
                    Commission Custom Art
                </a>
                {% if breadcrumb_medium %}
                <a href="{% url 'gallery' %}" class="btn btn-secondary">
                    View All Artworks
                </a>
                {% else %}
                <a href="{% url 'shop' %}" class="btn btn-primary">
                    Shop Available Works
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
/* Medium Navigation Pills */
.medium-pill {
    @apply px-6 py-3 rounded-full text-sm font-medium transition-all duration-200;
    @apply bg-surface text-secondary border border-muted;
    @apply hover:bg-primary-50 hover:text-primary-700 hover:border-primary-200;
}

.medium-pill.active {
    @apply bg-primary-500 text-white border-primary-500;
    @apply shadow-lg;
}

/* Status badges */
.status-available {
    @apply bg-green-100 text-green-800;
}

.status-sold {
    @apply bg-red-100 text-red-800;
}

.status-commission {
    @apply bg-blue-100 text-blue-800;
}

.status-badge {
    @apply text-xs px-2 py-1 rounded-full font-medium;
}

/* View toggle buttons */
.view-toggle {
    @apply text-neutral-500 hover:text-neutral-700 transition-colors;
}

.view-toggle.active {
    @apply bg-white text-primary-600 shadow-sm;
}

/* Gallery Layout Systems - Variable Width Masonry (from shop) */
.gallery-grid-large,
.gallery-grid-small {
    position: relative;
    width: 100%;
    min-height: 400px;
}

/* Variable width masonry items */
.gallery-grid-large .artwork-item,
.gallery-grid-small .artwork-item {
    position: absolute;
    transition: all 0.3s ease;
}

/* Only force display block when not filtered */
.gallery-grid-large .artwork-item:not(.filter-hidden),
.gallery-grid-small .artwork-item:not(.filter-hidden) {
    display: block !important;
}

/* Natural dimensions for masonry layout */
.artwork-image-container,
.gallery-grid-large .artwork-image-container,
.gallery-grid-small .artwork-image-container {
    max-width: 100%;
    position: relative;
}

.artwork-image {
    max-width: 100%;
    display: block;
}

/* Gallery Filter Pills */
.medium-filter-pill {
    @apply px-6 py-3 rounded-full text-sm font-medium transition-all duration-200;
    @apply bg-surface text-secondary border border-muted;
    @apply hover:bg-primary-50 hover:text-primary-700 hover:border-primary-200;
    @apply cursor-pointer;
}

.medium-filter-pill.active {
    @apply bg-primary-500 text-white border-primary-500;
    @apply shadow-lg;
}

/* Filter transitions */
.artwork-item {
    transition: opacity 0.2s ease, transform 0.2s ease;
}

.artwork-item.filter-hidden {
    display: none;
}

/* Text outline for enhanced readability */
.text-outline {
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

/* Initial stacked layout - all cards start in top-left position */
.artwork-item.initial-stacked {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 320px !important;
    max-width: 320px !important;
    display: inline-block !important;
    vertical-align: top !important;
    margin: 0 1.5rem 1.5rem 0 !important;
    opacity: 0.8;
    transform: scale(0.95);
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
}

/* Cards animate to their final positions */
.artwork-item.positioned {
    opacity: 1;
    transform: scale(1);
    z-index: auto;
}

/* Responsive initial sizing for stacked cards - matching shop */
@media (max-width: 640px) {
    .artwork-item.initial-stacked {
        width: 280px !important;
        max-width: 280px !important;
    }
}

@media (min-width: 1280px) {
    .artwork-item.initial-stacked {
        width: 350px !important;
        max-width: 350px !important;
    }
}

</style>
{% endblock %}

{% block extra_js %}
<script>
// Gallery masonry using complete shop implementation
document.addEventListener('DOMContentLoaded', function() {
    
    // Stacked Animation Masonry Layout (from shop)
    let masonryInProgress = false;
    let masonryTimeout = null;
    
    // Animation state tracking - remember which view sizes have been animated for gallery page
    let galleryAnimatedViews = new Set();
    let isInitialLoad = true; // Track if this is the first load
    
    function shouldRunStackingAnimation(viewSize) {
        const key = `gallery-${viewSize}`;
        // Always run animation on initial load, then check if already animated
        if (isInitialLoad) {
            return true;
        }
        return !galleryAnimatedViews.has(key);
    }
    
    function markViewAsAnimated(viewSize) {
        const key = `gallery-${viewSize}`;
        galleryAnimatedViews.add(key);
        if (isInitialLoad) {
            isInitialLoad = false; // No longer initial load after first animation
        }
    }
    
    function initVariableMasonry() {
        // Cancel any pending masonry calls
        if (masonryTimeout) {
            clearTimeout(masonryTimeout);
            masonryTimeout = null;
        }
        
        // If masonry is in progress, cancel it and start fresh
        if (masonryInProgress) {
            masonryInProgress = false;
            // Small delay to ensure previous operation is fully cancelled
            masonryTimeout = setTimeout(initVariableMasonry, 50);
            return;
        }
        
        masonryInProgress = true;
        
        try {
            const container = document.getElementById('gallery-container');
            if (!container) {
                masonryInProgress = false;
                clearTimeout(emergencyTimeout);
                return;
            }
            
            const items = Array.from(container.querySelectorAll('.artwork-item:not(.filter-hidden)'));
            
            if (items.length === 0) {
                masonryInProgress = false;
                clearTimeout(emergencyTimeout);
                return;
            }
            
            // Set container for absolute positioning
            container.style.position = 'relative';
            
            // Calculate responsive layout
            const isSmallView = container.classList.contains('gallery-grid-small');
            const viewSize = isSmallView ? 'small' : 'large';
            const containerWidth = container.offsetWidth;
            const gap = isSmallView ? 12 : 24;
            
            let columns;
            if (isSmallView) {
                if (window.innerWidth >= 1280) columns = 6;
                else if (window.innerWidth >= 1024) columns = 5;
                else if (window.innerWidth >= 768) columns = 4;
                else if (window.innerWidth >= 640) columns = 3;
                else columns = 2;
            } else {
                if (window.innerWidth >= 1280) columns = 4;
                else if (window.innerWidth >= 1024) columns = 3;
                else if (window.innerWidth >= 640) columns = 2;
                else columns = 1;
            }
            
            // Calculate base item width for columns with proper spacing
            const totalGapSpace = gap * (columns - 1);
            const rightMargin = gap; // Add right margin to prevent compression
            const availableSpace = containerWidth - totalGapSpace - rightMargin;
            let baseItemWidth = Math.floor(availableSpace / columns);
            
            // Define width variations (very subtle for minimal spacing impact)
            const widthVariations = [1.0, 1.03, 0.97, 1.05, 0.95, 1.02, 1.04, 0.98, 1.06, 1.01];
            
            // Ensure varying widths don't exceed available space
            const maxVariation = Math.max(...widthVariations);
            const maxItemWidth = baseItemWidth * maxVariation;
            if (maxItemWidth > (availableSpace / columns)) {
                baseItemWidth = Math.floor(availableSpace / (columns * maxVariation));
            }
            const columnHeights = new Array(columns).fill(0);
            
            // Check if stacking animation should run for this view size
            const runStackingAnimation = shouldRunStackingAnimation(viewSize);
            
            if (runStackingAnimation) {
                // STEP 1: Stack all items in top-left position first
                items.forEach((item, index) => {
                    item.classList.remove('positioned');
                    item.classList.add('initial-stacked');
                    // First items (lower index) get higher z-index so they're on top of visual stack
                    item.style.zIndex = items.length - index;
                });
                
                // Force reflow to apply stacked styles
                container.offsetHeight;
                
                // STEP 2: After brief pause, animate items to their final positions
                setTimeout(() => {
                    positionItemsSequentiallyFromStack(items, container, baseItemWidth, gap, columns, columnHeights, isSmallView, 150, containerWidth, widthVariations)
                        .then(() => {
                            markViewAsAnimated(viewSize); // Mark this view size as animated
                            finalizeMasonryLayout(container, columnHeights, gap);
                        })
                        .catch(error => {
                            console.error('Masonry error:', error);
                            masonryInProgress = false;
                            clearTimeout(emergencyTimeout);
                        });
                }, 200); // Brief pause to show stacking effect
            } else {
                // Still show stacking but skip animation delay - go directly to positions
                items.forEach((item, index) => {
                    item.classList.remove('positioned');
                    item.classList.add('initial-stacked');
                    // First items (lower index) get higher z-index so they're on top of visual stack
                    item.style.zIndex = items.length - index;
                });
                
                // Force reflow to apply stacked styles
                container.offsetHeight;
                
                // Immediately position without delay
                positionItemsSequentiallyFromStack(items, container, baseItemWidth, gap, columns, columnHeights, isSmallView, 0, containerWidth, widthVariations) // 0 delay
                    .then(() => {
                        finalizeMasonryLayout(container, columnHeights, gap);
                    })
                    .catch(error => {
                        console.error('Direct masonry error:', error);
                        masonryInProgress = false;
                        clearTimeout(emergencyTimeout);
                    });
            }
        } catch (error) {
            console.error('Masonry initialization error:', error);
            masonryInProgress = false;
            clearTimeout(emergencyTimeout);
        }
    }
    
    // Finalize masonry layout function
    function finalizeMasonryLayout(container, columnHeights, gap) {
        // Set final container height with extra bottom padding to prevent overlap
        const maxHeight = Math.max(...columnHeights);
        const extraPadding = gap * 2;
        const finalHeight = maxHeight + extraPadding;
        
        container.style.height = `${finalHeight}px`;
        container.style.marginBottom = `${gap * 3}px`;
        
        // Ensure container doesn't overflow
        container.style.overflow = 'visible';
        container.style.position = 'relative';
        container.style.zIndex = '1';
        
        const minHeight = Math.min(600, finalHeight);
        if (finalHeight < minHeight) {
            container.style.height = `${minHeight}px`;
        }
        
        masonryInProgress = false;
    }
    
    
    async function positionItemsSequentiallyFromStack(items, container, baseItemWidth, gap, columns, columnHeights, isSmallView, delay, containerWidth, widthVariations) {
        return new Promise((resolve) => {
            let processedItems = 0;
            
            items.forEach((item, index) => {
                // Use delay parameter - 150ms for animated, 0ms for direct
                const itemDelay = delay !== undefined ? delay : 150;
                // First items (index 0) are on top of visual stack and should animate first
                setTimeout(() => {
                    // Remove stacked class and add positioned class
                    item.classList.remove('initial-stacked');
                    item.classList.add('positioned');
                    
                    // Calculate varying width for this item
                    const variationIndex = index % widthVariations.length;
                    const itemWidth = Math.floor(baseItemWidth * widthVariations[variationIndex]);
                    
                    // Position the item in its final location
                    positionSingleItemFromStack(item, itemWidth, gap, columns, columnHeights, isSmallView, containerWidth);
                    processedItems++;
                    
                    if (processedItems === items.length) {
                        // All items processed - use shorter delay for direct positioning
                        const completionDelay = itemDelay === 0 ? 50 : 300;
                        setTimeout(resolve, completionDelay);
                    }
                }, index * itemDelay); // First items (index 0) animate first, last items animate last
            });
        });
    }

    function positionSingleItemFromStack(item, itemWidth, gap, columns, columnHeights, isSmallView, containerWidth) {
        const img = item.querySelector('.artwork-image');
        
        // Calculate image height based on aspect ratio
        let aspectRatio = 1.25; // Default 4:5 ratio
        if (img && img.naturalWidth && img.naturalHeight) {
            aspectRatio = img.naturalWidth / img.naturalHeight;
        }
        
        const width = itemWidth;
        const imageHeight = width / aspectRatio;
        
        // Calculate base column width for positioning
        const baseColWidth = Math.floor((containerWidth - (gap * (columns - 1))) / columns);
        
        // Use standard shortest column approach for consistent spacing
        let shortestColumn = 0;
        let shortestHeight = columnHeights[0];
        
        for (let col = 1; col < columns; col++) {
            if (columnHeights[col] < shortestHeight) {
                shortestColumn = col;
                shortestHeight = columnHeights[col];
            }
        }
        
        // Use shortest column position
        const bestPosition = {
            column: shortestColumn,
            x: shortestColumn * (baseColWidth + gap),
            y: shortestHeight,
            columnsAffected: 1
        };
        
        const x = bestPosition.x;
        const y = bestPosition.y;
        
        // Use transform-based animation to avoid CSS positioning conflicts
        item.style.transition = 'none';
        item.style.position = 'absolute';
        item.style.left = '0px';
        item.style.top = '0px';
        item.style.width = `${width}px`;
        
        // Start with no transform (at stack position), then animate to final position
        item.style.transform = 'translate(0px, 0px)';
        
        // Force reflow to apply initial state
        item.offsetLeft;
        
        // Enable smooth transform animation
        item.style.transition = 'transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
        
        // Animate to final position using transform
        setTimeout(() => {
            item.style.transform = `translate(${x}px, ${y}px)`;
        }, 50);
        
        // Update image container dimensions
        const imageContainer = item.querySelector('.artwork-image-container');
        if (imageContainer) {
            imageContainer.style.width = `${width}px`;
            imageContainer.style.height = `${imageHeight}px`;
        }
        
        // Set image to fill container
        if (img) {
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
        }
        
        // Update only the assigned column height
        const newColumnHeight = y + imageHeight + gap;
        columnHeights[bestPosition.column] = newColumnHeight;
    }
    
    // View toggle functionality
    const viewToggles = document.querySelectorAll('.view-toggle');
    const galleryContainer = document.getElementById('gallery-container');
    
    viewToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const view = this.dataset.view;
            
            // Update active state
            viewToggles.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Update gallery layout
            if (view === 'small') {
                galleryContainer.classList.remove('gallery-grid-large');
                galleryContainer.classList.add('gallery-grid-small');
            } else {
                galleryContainer.classList.remove('gallery-grid-small');
                galleryContainer.classList.add('gallery-grid-large');
            }
            
            // Store user preference
            localStorage.setItem('gallery-view', view);
            
            // Re-run masonry layout
            setTimeout(() => {
                initVariableMasonry();
            }, 100);
        });
    });
    
    // Restore user preference
    const savedView = localStorage.getItem('gallery-view');
    if (savedView) {
        const targetToggle = document.querySelector(`[data-view="${savedView}"]`);
        if (targetToggle) {
            targetToggle.click();
        }
    }
    
    // Initialize gallery filtering
    setupGalleryFiltering();
    
    // Initialize masonry on load
    setTimeout(() => {
        initVariableMasonry();
    }, 100);
    
    // Re-run on resize
    window.addEventListener('resize', () => {
        setTimeout(initVariableMasonry, 100);
    });
});

function setupGalleryFiltering() {
    // Medium filter pills
    const mediumPills = document.querySelectorAll('.medium-filter-pill');
    const searchInput = document.getElementById('gallery-search-input');
    const featuredFilter = document.getElementById('featured-filter');
    
    // Medium filter handling
    mediumPills.forEach(pill => {
        pill.addEventListener('click', function() {
            // Update active state
            mediumPills.forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            
            // Apply filters with loading state
            filterGalleryArtworksWithLoading();
        });
    });
    
    // Search input handling
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterGalleryArtworksWithLoading();
        }, 300);
    });
    
    // Featured filter handling
    featuredFilter.addEventListener('change', function() {
        filterGalleryArtworksWithLoading();
    });
}

function filterGalleryArtworks() {
    const activeMedium = document.querySelector('.medium-filter-pill.active').dataset.medium;
    const searchTerm = document.getElementById('gallery-search-input').value.toLowerCase();
    const showFeaturedOnly = document.getElementById('featured-filter').checked;
    
    const items = document.querySelectorAll('#gallery-container .artwork-item');
    let visibleCount = 0;
    
    items.forEach(item => {
        const medium = item.dataset.medium ? item.dataset.medium.toLowerCase() : '';
        const title = item.dataset.title ? item.dataset.title.toLowerCase() : '';
        const isFeatured = item.querySelector('.bg-primary'); // Check for featured badge
        
        let shouldShow = true;
        
        // Medium filter
        if (activeMedium !== 'all') {
            shouldShow = shouldShow && medium.includes(activeMedium);
        }
        
        // Search filter
        if (searchTerm) {
            shouldShow = shouldShow && (title.includes(searchTerm) || medium.includes(searchTerm));
        }
        
        // Featured filter
        if (showFeaturedOnly) {
            shouldShow = shouldShow && isFeatured;
        }
        
        // Apply filter
        if (shouldShow) {
            item.classList.remove('filter-hidden');
            item.style.opacity = '1';
            item.style.pointerEvents = 'auto';
            visibleCount++;
        } else {
            item.classList.add('filter-hidden');
            item.style.opacity = '0.3';
            item.style.pointerEvents = 'none';
        }
    });
    
    // Re-layout masonry after filtering
    setTimeout(() => {
        initVariableMasonry();
    }, 100);
    
    // Update results count (if exists)
    const resultsElement = document.querySelector('.text-secondary');
    if (resultsElement && resultsElement.textContent.includes('Showing')) {
        resultsElement.textContent = `Showing ${visibleCount} artworks`;
    }
}

// Optimized filter function with minimal loading states
function filterGalleryArtworksWithLoading() {
    const gallery = document.getElementById('gallery-container');
    
    // Only show loading state for complex filters, not simple ones
    const searchTerm = document.getElementById('gallery-search-input').value;
    const showFeaturedOnly = document.getElementById('featured-filter').checked;
    const isComplexFilter = searchTerm.length > 0 || showFeaturedOnly;
    
    if (isComplexFilter) {
        // Brief loading indication for complex filters
        gallery.style.transition = 'opacity 0.15s ease';
        gallery.style.opacity = '0.8';
    }
    
    // Apply filters immediately
    filterGalleryArtworks();
    
    // Re-layout with minimal delay
    requestAnimationFrame(() => {
        initVariableMasonry();
        
        if (isComplexFilter) {
            // Quick restore for complex filters
            setTimeout(() => {
                gallery.style.opacity = '1';
            }, 100);
        }
    });
}
</script>
{% endblock %}